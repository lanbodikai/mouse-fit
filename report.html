<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mouse Fit — Measurement Report</title>
    <link rel="stylesheet" href="src/neon.css">
    <style>
      :root { --bg: #0b0b0f; --fg: #e8e8f0; --sub: #a8a8b3; }
      body { margin: 0; padding: 20px; font-family: system-ui, Segoe UI, Inter, Arial; background: var(--bg); color: var(--fg); }
      h1 { font-size: 18px; margin-bottom: 12px; }
      h2 { font-size: 16px; margin: 24px 0 8px; }
      h3 { font-size: 15px; margin: 12px 0 4px; }
      p { font-size: 14px; margin: 4px 0; }
      .result-container {
        display: grid;
        grid-template-columns: minmax(260px, 420px) 1fr;
        gap: 24px;
        align-items: start;
      } 
      #snapshot {
        width: min(100%, 420px);
        height: auto;
        border: 2px solid #ffffff;
        border-radius: 8px;
        display: block;
      }
      @media (max-width: 720px) {
        .result-container { grid-template-columns: 1fr; }
        #snapshot { width: 100%; }
      }

      ul { list-style: disc; margin: 4px 0 16px 20px; }
      li { margin-bottom: 4px; line-height: 1.4; }
      .note { font-size: 13px; color: var(--sub); margin-top: 4px; }

      /* Grip checker button + status */
      .btn-link {
        display:inline-block; background:#0d1a21; color:#fff;
        border:1px solid #1f3a47; padding:10px 14px; border-radius:12px;
        font-weight:600; text-decoration:none;
      }
      .btn-link:hover { filter:brightness(1.05); }

      .pill { padding:4px 10px; border-radius:999px; background:#0f1524;
              border:1px solid #2a2f40; font-size:12px; color:#cfe9f6; }

      #gripBox { display:flex; gap:12px; align-items:center; margin:10px 0 14px; }

      /* (optional) thumbnails of the 3 grip views you captured */
      .grip-thumbs { display:flex; gap:8px; margin-top:4px; }
      .grip-thumbs img { width:84px; height:56px; object-fit:cover;
                         border-radius:8px; border:1px solid #2a2f40; background:#0b0b0f; }
        
    </style>
  </head>
  <body>
    <h1>Your Hand Measurement Report</h1>
    <div class="result-container">
      <!-- Snapshot of the hand capture -->
      <img id="snapshot" alt="Hand snapshot" />
      <!-- Measurement details -->
      <div id="measurements">
        <p><strong>Hand length:</strong> <span id="handLength"></span> cm</p>
        <p><strong>Palm width:</strong> <span id="handWidth"></span> cm</p>
        <p><strong>Hand size category:</strong> <span id="handSize"></span></p>
        <p><strong>Suggested grip style(s):</strong> <span id="suggestedGrip"></span></p>
      </div>
    </div>
    
      <div id="gripBox">
        <a href="./grip.html" class="btn-link">Open Grip Checker</a>
        <button id="redoBtn">Redo test</button>
        <button id="askAI" class="btn-link">Ask MouseFit AI</button>
        <span id="gripPill" class="pill">Grip: not checked</span>
      </div>

      <!-- (optional) show the 3 captured views when available -->
      <div id="gripThumbs" class="grip-thumbs" style="display:none;">
        <img id="gripTop"   alt="Top view">
        <img id="gripRight" alt="Right view">
        <img id="gripLeft"  alt="Left view">
      </div>

    <h2>Recommended Mice</h2>
    <p class="note">Top picks for each grip style, sorted by compatibility:</p>
    <h3>Palm Grip Recommendations</h3>
    <ul id="listPalm"></ul>
    <h3>Claw Grip Recommendations</h3>
    <ul id="listClaw"></ul>
    <h3>Fingertip Grip Recommendations</h3>
    <ul id="listFingertip"></ul>

    <script>
      // Retrieve measurement and recommendation data from localStorage
      const measure = JSON.parse(localStorage.getItem("mousefit:measure") || "{}");
      const rec = JSON.parse(localStorage.getItem("mousefit:recs") || "{}");
      // If no data is found (e.g., user navigated here directly), display a message
      if (!measure.len_cm) {
        document.body.innerHTML = "<p>No measurement data found. Please return to the main page to measure your hand.</p>";
      } else {
        // Display snapshot image (if available)
        const snapshotData = localStorage.getItem("mousefit:snapshot");
        if (snapshotData) {
          document.getElementById("snapshot").src = snapshotData;
        } else {
          // If no snapshot was saved, hide the image element
          document.getElementById("snapshot").style.display = "none";
        }
        // Show measured length and width (in centimeters, one decimal place as saved)
        document.getElementById("handLength").textContent = measure.len_cm;
        document.getElementById("handWidth").textContent = measure.wid_cm;
        document.getElementById("handSize").textContent = rec.size;

        // Suggested grip style(s) based on hand size category
        const size = rec.size;
        let gripSuggestion = "";
        if (size === "small") {
          gripSuggestion = "You might find a claw grip comfortable (small hands often work well with claw grip), though palm grip is also a versatile choice.";
        } else if (size === "medium") {
          gripSuggestion = "Palm grip is a versatile choice for medium hands (works well for most hand sizes). You can also experiment with claw or fingertip grip based on personal preference.";
        } else if (size === "large" || size === "xlarge") {
          gripSuggestion = "With a larger hand, a fingertip grip can feel natural, though palm grip (which suits most hand sizes) may also be comfortable.";
        } else {
          gripSuggestion = "Any grip style can be used — choose what feels most natural to you.";
        }
        document.getElementById("suggestedGrip").textContent = gripSuggestion;

        // Helper to create a list item text for a mouse recommendation
        function formatMouseEntry(m) {
          return `${m.brand} ${m.model} — ${m.weight_g} g — ${m.width_mm} mm wide, ${m.height_mm} mm tall — ${m.shape} (${m.tags && m.tags.length ? m.tags.join("/") : "suitable for "+currentGrip+" grip"})`;
        }

        // Populate recommendation lists for each grip category
        // === Populate recommendation lists, filtered by detected grip preference ===
        const ulPalm = document.getElementById("listPalm");
        const ulClaw = document.getElementById("listClaw");
        const ulTip  = document.getElementById("listFingertip");

        // helper to hide the <h3> above any UL we suppress
        function hideHeading(ul) {
          const h = ul && ul.previousElementSibling;
          if (h && /^H\d$/.test(h.tagName)) h.style.display = "none";
        }

        // helper to render items (keeps your existing line format)
        function addItems(ul, arr, label) {
          ul.innerHTML = "";
          if (!arr || !arr.length) {
            const li = document.createElement("li");
            li.textContent = "No data available";
            ul.appendChild(li);
            return;
          } 
          arr.forEach(mouse => {
            const li = document.createElement("li");
            // tweak this line if you want a different display string
            li.textContent =
              `${mouse.brand} ${mouse.model} — ${mouse.weight_g} g — ` +
              `${mouse.length_mm}×${mouse.width_mm}×${mouse.height_mm} mm — ` +
              `${mouse.shape} (${label} grip)`;
            ul.appendChild(li);
          });
        }

        let palmList = (rec.top && rec.top.palm) || [];
        let clawList = (rec.top && rec.top.claw) || [];
        let tipList  = (rec.top && rec.top.fingertip) || [];

        // read preference saved by grip.js (e.g., { grip:"claw", relaxed:true })
        const pref = JSON.parse(localStorage.getItem("mousefit:grip_pref") || "{}");
        const handLenMm = Number(measure.len_mm || 0);

        // relaxed claw → bias to slightly larger claw mice (length >= ~64% of hand length)
        if (pref.grip === "claw" && pref.relaxed && handLenMm) {
          const minLen = 0.64 * handLenMm;
          const getLen = m => Number(m.length_mm ?? m.length ?? 0);
          const larger = clawList.filter(m => getLen(m) >= minLen);
          if (larger.length) clawList = larger;  // keep original if filter would empty the list
        }

        // show only the preferred grip’s list; hide the others (and their headings)
        if (pref.grip === "palm") {
          addItems(ulPalm, palmList, "Palm");
          ulClaw.innerHTML = ""; ulTip.innerHTML = "";
          hideHeading(ulClaw); hideHeading(ulTip);
        } else if (pref.grip === "claw") {
          addItems(ulClaw, clawList, pref.relaxed ? "Claw (relaxed bias)" : "Claw");
          ulPalm.innerHTML = ""; ulTip.innerHTML = "";
          hideHeading(ulPalm); hideHeading(ulTip);
        } else if (pref.grip === "fingertip") {
          addItems(ulTip, tipList, "Fingertip");
          ulPalm.innerHTML = ""; ulClaw.innerHTML = "";
          hideHeading(ulPalm); hideHeading(ulClaw);
        } else {
        // no pref → show all three as before
          addItems(ulPalm, palmList, "Palm");
          addItems(ulClaw, clawList, "Claw");
          addItems(ulTip,  tipList,  "Fingertip");
        }
      }
        /* === Grip result/status pulled from Grip Checker === */
        (function showGrip() {
          const pill = document.getElementById("gripPill");
          if (!pill) return;

       // show thumbnails if the 3-angle captures exist
            const topB64   = localStorage.getItem("mousefit:grip_view_top");
            const rightB64 = localStorage.getItem("mousefit:grip_view_right");
            const leftB64  = localStorage.getItem("mousefit:grip_view_left");
          if (topB64 || rightB64 || leftB64) {
            const box = document.getElementById("gripThumbs");
          if (box) box.style.display = "flex";
          if (topB64)   document.getElementById("gripTop").src   = topB64;
          if (rightB64) document.getElementById("gripRight").src = rightB64;
          if (leftB64)  document.getElementById("gripLeft").src  = leftB64;
        }

      // read the AI (or local heuristic) result saved by grip.js
          try {
            const r = JSON.parse(localStorage.getItem("mousefit:grip_result") || "{}");
            const grip = (r.grip || r.local_guess?.grip || "").toLowerCase();
            const conf = Math.round(100 * (r.confidence ?? r.local_guess?.confidence ?? 0));
          if (grip) pill.textContent = conf ? `Grip: ${grip} (${conf}%)` : `Grip: ${grip}`;
          }  catch { /* ignore */ }
        })();

    </script>
    <script>
  (function wireAskAI(){
    const btn = document.getElementById('askAI');
    if (!btn) return;

    btn.onclick = () => {
      // read measurement from localStorage
      let lenCm = "", widCm = "", grip = "";
      try {
        const m = JSON.parse(localStorage.getItem("mousefit:measure") || "{}");
        if (m.len_mm) lenCm = (m.len_mm / 10).toFixed(1);
        if (m.wid_mm) widCm = (m.wid_mm / 10).toFixed(1);
      } catch {}

      // optional grip if present
      grip = localStorage.getItem("gripGuess")
          || localStorage.getItem("mousefit:grip")
          || "";

      // build query string for ai.html
      const params = new URLSearchParams();
      if (lenCm) params.set("len", lenCm);
      if (widCm) params.set("wid", widCm);
      if (grip)  params.set("grip", grip.toLowerCase());

      // go to the AI page with prefilled values
      window.location.href = "./ai.html?" + params.toString();
    };
  })();
</script>
  </body>
</html>
