<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Mouse Fit — Hand Measure MVP</title>
    <style>
      :root { --bg: #0b0b0f; --fg: #e8e8f0; --sub: #a8a8b3; --pill: #131725; --pillb: #2a2f40; }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: system-ui, Segoe UI, Inter, Arial; background: var(--bg); color: var(--fg); }
      header { padding: 12px 16px; border-bottom: 1px solid #1b1b24; display: flex; gap: 10px; align-items: center; }
      header h1 { margin: 0; font-size: 16px; }
      .pill { padding: 2px 8px; border-radius: 999px; background: var(--pill); border: 1px solid var(--pillb); font-size: 12px; color: #b7c8d6; }

      .wrap { position: relative; height: 100dvh; }
      video, canvas { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
      video { z-index: 0; } 
      canvas { z-index: 1; }

      .guides { position: absolute; left: 5vw; right: 5vw; top: 8vh; bottom: 26vh; display: flex; gap: 20px; align-items: center; justify-content: center; pointer-events: none; z-index: 2; }
      .guide { border: 3px dashed rgba(255,255,255,0.65); border-radius: 14px; background: rgba(255,255,255,0.06); position: relative; }
      .label { position: absolute; top: -14px; left: 14px; background: #11131b; border: 1px solid #2a2f40; color: #cfe9f6; font-size: 12px; font-weight: 700; padding: 3px 8px; border-radius: 999px; }
      #handGuide { flex: 3 1 0; min-height: 56vh; }
      #cardGuide { flex: 1 0 0; max-width: 260px; min-height: 150px; border-color: rgba(110,231,255,0.9); background: rgba(110,231,255,0.08); }

      .hud { position: absolute; left: 0; right: 0; bottom: 0; padding: 12px; background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.55) 30%, rgba(0,0,0,0.75) 100%); z-index: 5; }
      .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      button { background: #11131b; color: var(--fg); border: 1px solid #262b37; border-radius: 12px; padding: 10px 14px; font-weight: 600; cursor: pointer; }
      button.primary { border-color: #1f3a47; background: #0d1a21; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      select { background: #0e1220; color: #e8eef7; border: 1px solid #2b3241; border-radius: 10px; padding: 8px; }
      .hint { font-size: 14px; color: var(--sub); margin: 8px 0 10px; }
      .badge { position: absolute; right: 10px; top: 10px; background: #11131b; border: 1px solid #263041; color: #9fcde2; font-size: 12px; padding: 4px 8px; border-radius: 999px; z-index: 6; }
      .toast { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: #11131b; border: 1px solid #2a3442; color: #cdd8e4; padding: 8px 12px; border-radius: 10px; font-size: 13px; display: none; z-index: 7; }
      .countdown { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.35); font-size: 22vmin; font-weight: 900; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.6); pointer-events: none; z-index: 8; }

      .point { position: absolute; width: 18px; height: 18px; border-radius: 50%; border: 2px solid #e5f8ff; background: #0b2a33aa; box-shadow: 0 0 0 2px rgba(0,0,0,0.3); transform: translate(-50%, -50%); touch-action: none; cursor: grab; pointer-events: auto; display: none; z-index: 10; }
      .point.green { border-color: #a3ffb0; background: #0b3316aa; }
      .point.blue  { border-color: #9fe9ff; background: #0b2b44aa; }

      @media (max-width: 700px) {
        .guides { top: 6vh; bottom: 28vh; flex-direction: column; gap: 14px; align-items: stretch; }
        #handGuide { min-height: 46vh; }
        #cardGuide { max-width: none; min-height: 18vh; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Mouse Fit — Camera Measure (MVP)</h1>
      <span class="pill">alpha</span>
    </header>

    <div class="wrap">
      <video id="cam" playsinline autoplay muted></video>
      <canvas id="frame"></canvas>

      <!-- Guide boxes for hand and card placement -->
      <div class="guides" id="guides">
        <div id="handGuide" class="guide"><span class="label">Hand here</span></div>
      </div>

      <!-- Status and notifications -->
      <div id="status" class="badge">Live</div>
      <div id="toast" class="toast"></div>
      <div id="countdown" class="countdown">5</div>

      <!-- Draggable corner points for the credit card (p0–p3) -->
      <div id="p0" class="point"></div>
      <div id="p1" class="point"></div>
      <div id="p2" class="point"></div>
      <div id="p3" class="point"></div>
      <!-- Draggable points for palm width (green) -->
      <div id="wL" class="point green"></div>
      <div id="wR" class="point green"></div>
      <!-- Draggable points for hand length (blue) -->
      <div id="hA" class="point blue"></div>
      <div id="hB" class="point blue"></div>

      <!-- Heads-up display with controls -->
      <div class="hud">
        <!-- Camera selection and skeleton toggle -->
        <div class="row" style="gap:12px; margin-bottom:6px;">
          <label>Camera:</label>
          <select id="cameraSelect"></select>
          <button id="refreshCams">Refresh</button>
          <span id="camName" class="pill">—</span>
          <span id="skelState" class="pill">Skeleton: On</span>
          <button id="toggleSkel">Turn off skeleton</button>
        </div>

        <div id="hint" class="hint">
          Tip: Press <b>Space</b> to start a 5-second timer, then keep your <b>hand</b> and a <b>credit card</b> in the dotted boxes.
        </div>

        <!-- Live capture buttons -->
        <div class="row" id="liveBtns">
          <button id="timer" class="primary">Capture in 5 Seconds (Space)</button>
          <button id="snap">Capture now</button>
          <span id="step" class="pill">Step: live</span>
        </div>

        <!-- Refinement buttons (after snapshot) -->
        <div class="row" id="refineRow" style="display:none; gap:8px;">
          <button id="snapEdges">Snap palm edges</button>
          <button id="snapTip">Snap fingertip</button>
          <button id="confirm">Confirm (Enter)</button>
          <button id="reset">Reset (Esc)</button>
        </div>
      </div>
    </div>

    <!-- Autoplay fallback (iOS/Safari & strict browsers) -->
    <button id="startCamBtn" style="
      position:fixed; inset:auto 12px 12px auto; z-index:9999;
      background:#0d1a21; color:#fff; border:1px solid #1f3a47; 
      padding:10px 14px; border-radius:12px; display:none;">
      Tap to start camera
    </button>

    <script type="module" src="./main.js"></script>
    <!-- First-run tip for Measure -->
    <div id="introMeasure" style="
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); z-index:10000;">
      <div style="max-width:520px; background:#0f1320; border:1px solid #2a3442; color:#e8eef7;
                  padding:18px 18px 14px; border-radius:16px; box-shadow:0 12px 40px rgba(0,0,0,.45)">
        <h3 style="margin:0 0 8px; font-size:18px;">Welcome to Mouse-Fit (MVP)</h3>
        <p style="margin:0 0 10px; line-height:1.5;">
          Please hold a <b>credit card</b> and your <b>palm</b> side by side in view.<br>
          After capture, drag the four aqua corners onto the card, and adjust the green/blue lines if needed.
        </p>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="introMeasureOk" style="background:#0d1a21; color:#fff; border:1px solid #1f3a47;
                  padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer">Got it</button>
        </div>
      </div>
    </div>

    <script>
    (() => {
      const KEY = "mousefit:intro_measure_v1";
      const el = document.getElementById("introMeasure");
      if (!localStorage.getItem(KEY)) el.style.display = "flex";
      document.getElementById("introMeasureOk").onclick = () => {
        localStorage.setItem(KEY, "1");
        el.style.display = "none";
      };
    })();
    </script>
  </body>
</html>
