<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Mouse-Fit — Hand Measure</title>

<link rel="stylesheet" href="/neon.css" />
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@500;700&display=swap" rel="stylesheet" />
<script src="/js/nav.js" defer></script>

<style>
:root{
  --bg:#05060a; --fg:#eaf0ff; --sub:#a6b0c8;
  --border:rgba(255,255,255,.10);
  --g1:#7c3aed; --g2:#22d3ee; --g3:#a78bfa;
  --stage-offset-y: 40px; 
  --stage-offset-x: 100px; 
}
*{box-sizing:border-box}

/* lock the page (no scrolling) */
html,body{ height:100%; overflow:hidden; overscroll-behavior:none;
  background:
    radial-gradient(140% 120% at 20% -10%, #0c1022 0%, #0a0d1f 35%, rgba(0,0,0,0) 60%) fixed,
    linear-gradient(180deg, #0a0f1e 0%, #12102a 55%, #1a1240 100%) fixed !important; }
body{ margin:0; font-family:Lexend, system-ui, Arial; color:var(--fg); }

/* remove the thin neon page frame/borders entirely */
.page-frame{ display:none !important; }

/* ===== layout ===== */
.wrap{
  position:relative;
  height:100dvh;
  padding:16px;
  display:grid;
  place-items:center;   /* centers the stage */
}

/* bounded capture area */
.stage{
  
  position:relative;
  width:min(1000px, 88vw); /* tweak this to change size */
  max-height: calc(100dvh - 100px); /* tweak 120–180px to fit your nav + padding */
  aspect-ratio:16/9;
  border-radius:18px;
  translate: calc(-1 * var(--stage-offset-x)) calc(-1 * var(--stage-offset-y));
  overflow:hidden;      /* clip video/canvas/overlays to rounded rect */
    border: 2px solid rgba(167,139,250,.55);              /* was 1px */
  box-shadow:
    inset 0 0 0 2px rgba(34,211,238,.22),               /* was 1px */
    0 16px 50px rgba(12,20,35,.60),
    0 0 34px rgba(124,58,237,.28);
}

/* media fills only the stage */
.stage > video,
.stage > canvas{
  position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
}

/* overlays inside stage */
.stage .guides{
  position:absolute; left:4%; right:4%; top:4%; bottom:4%;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none; z-index:2;
}
.stage .guide{
  border:3px dashed rgba(255,255,255,.65);
  border-radius:14px; background:rgba(255,255,255,.06); position:relative;
}
.stage #handGuide{ flex:3 1 0; min-height:94%; }
.stage .label{
  position:absolute; top:-14px; left:14px;
  background:#0b1224; border:1px solid #263041;
  color:#cfe9f6; font-size:12px; font-weight:700;
  padding:3px 8px; border-radius:999px;
}

/* badges/toast/countdown */
.stage .badge{ position:absolute; right:10px; top:10px; background:#0e1424; border:1px solid #263041; color:#9fcde2; font-size:12px; padding:4px 8px; border-radius:999px; z-index:6 }
.stage .toast{ position:absolute; top:12px; left:50%; transform:translateX(-50%); background:#0e1424; border:1px solid #2a3442; color:#cdd8e4; padding:8px 12px; border-radius:10px; font-size:13px; display:none; z-index:7 }
.stage .countdown{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); font-size:22vmin; font-weight:900; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.6); pointer-events:none; z-index:8 }

/* draggable points (IDs unchanged for main.js) */
.point{ position:absolute; width:18px; height:18px; border-radius:50%; border:2px solid #e5f8ff; background:#0b2a33aa; box-shadow:0 0 0 2px rgba(0,0,0,.3); transform:translate(-50%,-50%); touch-action:none; cursor:grab; pointer-events:auto; display:none; z-index:10 }
.point.green{ border-color:#a3ffb0; background:#0b3316aa }
.point.blue{  border-color:#9fe9ff; background:#0b2b44aa }

/* ===== side control panel (now draggable & fixed) ===== */
.control-dock{
  position:fixed; top:50%; right:16px; transform:translateY(-50%); z-index:5; padding:0; background:none;
}
.panel{
  width:360px; max-height:min(84vh, 720px); overflow:auto;
  border:1px solid rgba(167,139,250,.25);
  background:    linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,.28)),
    rgba(9,12,22,.84) !important;      
  backdrop-filter: blur(8px);
  border-radius:14px;
  box-shadow: inset 0 0 0 1px rgba(34,211,238,.12), 0 8px 30px rgba(0,0,0,.35);
  padding:12px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.toolbar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-top:8px}
.btn-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.meta{display:flex;gap:10px;align-items:center;justify-content:flex-end}
/* Stack the meta pills vertically (both live & frozen toolbars) */
.panel .toolbar .meta{
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch;      /* make each pill full width */
  gap: 10px;
}

/* Make the pills look like neat rows */
.panel .toolbar .meta .pill{
  width: 100%;
  text-align: center;
}

.pill{padding:4px 10px;border-radius:999px;background:#0f1524;border:1px solid #2a2f40;font-size:12px;color:#cfe9f6}

button{background:#101626;color:var(--fg);border:1px solid #223049;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
button.primary{background:linear-gradient(90deg,var(--g1),var(--g2),var(--g3));border-color:transparent;box-shadow:0 0 18px rgba(124,58,237,.35),0 0 28px rgba(34,211,238,.22)}
select{background:#0e1220;color:#e8eef7;border:1px solid #2b3241;border-radius:10px;padding:8px}
.hint{font-size:14px;color:var(--sub);margin:6px 0 2px}
/* Guide box */
.coach{
  position: fixed;
  top: 96px;            /* start near the top */
  left: 24px;           /* start on the LEFT */
  width: 360px;
  padding: 0 12px 12px;
  border-radius: 16px;
  border: 1px solid rgba(167,139,250,.30);
  background:
      linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,.28)),
    rgba(9,12,22,.84) !important;      
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow:
    inset 0 0 0 1px rgba(34,211,238,.12),
    0 8px 30px rgba(0,0,0,.35);
  color: var(--fg);
  z-index: 60;
}
.coach.hidden{ display:none; }

/* Title/drag bar */
.coach-bar{
  height: 36px;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 8px 0 12px;
  margin: 8px 0 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.20);
  background: rgba(255,255,255,.10);
  cursor: move;              /* drag handle */
  user-select: none;
}
.coach-bar strong{ font-size: 14px; letter-spacing: .02em; color: #e7ecff; }

/* Close (X) */
.coach-close{
  width: 28px; height: 28px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.22);
  background: rgba(255,255,255,.12);
  color: #fff; font-weight: 800; line-height: 1;
  display: grid; place-items: center;
  cursor: pointer;
}
.coach-close:hover{ background: rgba(255,255,255,.18); }

.coach-content p{ margin: 6px 2px; color: #cfd6ee; line-height: 1.35; }



/* draggable handle */
.dock-handle{
  cursor:move; height:22px; margin:-4px -4px 8px -4px;
  border-radius:10px; background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:700; color:#cfe9f6; letter-spacing:.02em;
}
.dock-handle::after{ content:"Drag me"; opacity:.85; }
.control-dock.dragging, .control-dock .panel.dragging{ user-select:none; }
.control-dock.dragging .panel{
  box-shadow: inset 0 0 0 1px rgba(34,211,238,.22), 0 8px 30px rgba(0,0,0,.45), 0 0 0 3px rgba(124,58,237,.18);
}

/* ===== Mobile layout: scanner on top, toolbar bottom (draggable) ===== */
@media (max-width: 820px){
  html, body{ overflow:auto; overscroll-behavior:y contain; }
  .wrap{ height:auto; min-height:100dvh; padding:12px 12px calc(88px + env(safe-area-inset-bottom)); place-items:stretch; }
  .stage{
    width:min(100%, 96vw); max-height:none; aspect-ratio: 16/9;
    translate: 0 0;
  }
  .guides{ left:3%; right:3%; top:3%; bottom:3%; }
  .guide{ border-width:2px; }

  /* Dock pinned to bottom; still draggable via handle */
  .control-dock{ position:fixed; left:0; right:0; bottom:0; top:auto; transform:none; padding:0 8px calc(8px + env(safe-area-inset-bottom)); }
  .panel{
    width:auto; max-width:none; max-height:48dvh; border-radius:16px 16px 12px 12px;
    padding:10px; margin:0 auto; backdrop-filter: blur(12px);
  }
  .toolbar{ grid-template-columns:1fr; }
  .btn-group{ grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
  .meta{ justify-content:flex-start; }
}
</style>
</head>
<body>

<!-- (was the neon border) -->
<div class="page-frame" aria-hidden="true"></div>

<div class="wrap">
  <div class="stage">
    <video id="cam" playsinline autoplay muted></video>
    <canvas id="frame"></canvas>

    <!-- draggable handles (required by main.js) -->
    <div id="p0" class="point green"></div>
    <div id="p1" class="point green"></div>
    <div id="p2" class="point green"></div>
    <div id="p3" class="point green"></div>
    <div id="wL" class="point green"></div>
    <div id="wR" class="point green"></div>
    <div id="hA" class="point blue"></div>
    <div id="hB" class="point blue"></div>

    <!-- guides (kept inside stage) -->
    <div class="guides">
      <div id="handGuide" class="guide"><span class="label">Hand here</span></div>
      <div id="cardGuide" class="guide" style="display:none; width:22vmin; height:14vmin;">
        <span class="label">Card here (optional)</span>
      </div>
    </div>

    <div id="status" class="badge">Live</div>
    <div id="toast" class="toast"></div>
    <div id="countdown" class="countdown">5</div>
  </div>

  <!-- draggable side panel -->
  <div class="control-dock">
    <div class="panel">
      <div class="dock-handle"></div>

      <div class="row" style="gap:12px; margin-bottom:6px;">
        <label>Camera:</label>
        <select id="cameraSelect"></select>
        <button id="refreshCams">Refresh</button>
        <span id="camName" class="pill">—</span>
        <span id="skelState" class="pill">Skeleton: On</span>
      </div>

      <div id="hint" class="hint">
        Tip: Press <b>Space</b> to start a 5-second timer, then keep your <b>hand</b> and a <b>credit card</b> in the dotted box.
      </div>

      <!-- LIVE -->
      <div class="toolbar" id="liveBtns">
        <div class="btn-group">
          <button id="timer" class="primary">Capture in 5 Seconds (Space)</button>
          <button id="snap">Capture now</button>
          <button id="toggleSkel">Turn off skeleton</button>
          <button id="reset">Reset (Esc)</button>
        </div>
        <div class="meta">
  <span id="skelState" class="pill">Skeleton: On</span>
  <span id="stepPill"  class="pill">Step: live</span>
  <span id="viewPill"  class="pill">View: Top</span>
</div>
      </div>

      <!-- REFINE -->
      <div class="toolbar" id="refineRow" style="display:none;">
        <div class="btn-group">
          <button id="snapEdges">Snap palm edges</button>
          <button id="snapTip">Snap fingertip</button>
          <button id="confirm" class="primary">Confirm (Enter)</button>
          <button id="reset2">Reset (Esc)</button>
        </div>
        <div class="meta"><span class="pill">Refine</span></div>
      </div>
    </div>
  </div>
</div>

<button id="startCamBtn" style="position:fixed; inset:auto 12px 12px auto; z-index:9999; background:linear-gradient(90deg,var(--g1),var(--g2),var(--g3)); color:#fff; border:0; padding:10px 14px; border-radius:12px; display:none;">Tap to start camera</button>

<div class="coach" id="coach" data-key="mf:coach:measure" role="dialog" aria-live="polite">
  <div class="coach-bar" aria-label="Drag handle">
    <strong>Guide</strong>
    <button class="coach-close" aria-label="Dismiss">×</button>
  </div>
  <div class="coach-content">
    <p>1) Position your hand (and card) inside the dotted box<br/>(Card in hand is suggested)</p>
    <p>2) Press <b>Space</b> for a 5-second timer or use <b>Capture now</b>.</p>
    <p>3) Snap Fingertips, Hand Width <br/><b>(Manual adjustment is suggested)</b>.</p>
    <p>4) <b>Double click on the edge of the card for four corners</b><br/>(Top Left,TR,BR,BL).</p>
    <p>5) <b>Continue</b>.</p>
  </div>
</div>

<script>
(() => {
  const box = document.getElementById('coach');
  if (!box) return;
  const key = box.dataset.key || 'mf:coach';
  const handle = box.querySelector('.coach-bar');
  const closeBtn = box.querySelector('.coach-close');

  /* Always show on page load */
  box.classList.remove('hidden');
  // If you previously stored a hide flag, clear it (safe no-op otherwise)
  localStorage.removeItem(key + ':hide');

  /* Restore position (keep this so users can drag it where they like) */
  const saved = localStorage.getItem(key + ':pos');
  if (saved) {
    const { left, top } = JSON.parse(saved);
    box.style.left = left; box.style.top = top;
  }

  /* Close WITHOUT persistence (it will show again next visit) */
  closeBtn?.addEventListener('click', () => {
    box.classList.add('hidden');
  });

  /* Dragging (unchanged) */
  let dragging = false, grabDX = 0, grabDY = 0, w = 0, h = 0;
  const pt = (e) => (e.touches?.[0]) ? { x:e.touches[0].clientX, y:e.touches[0].clientY } : { x:e.clientX, y:e.clientY };

  function start(e){
    const r = box.getBoundingClientRect(), p = pt(e);
    dragging = true; w = r.width; h = r.height;
    grabDX = p.x - r.left; grabDY = p.y - r.top;
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', end);
    document.addEventListener('touchmove', move, { passive:false });
    document.addEventListener('touchend', end);
    e.preventDefault?.();
  }
  function move(e){
    if (!dragging) return;
    const p = pt(e), vw = innerWidth, vh = innerHeight, pad = 8;
    let x = p.x - grabDX, y = p.y - grabDY;
    x = Math.max(pad, Math.min(vw - w - pad, x));
    y = Math.max(pad, Math.min(vh - h - pad, y));
    box.style.left = `${x}px`; box.style.top = `${y}px`;
    if (e.cancelable) e.preventDefault();
  }
  function end(){
    if (!dragging) return;
    dragging = false;
    document.removeEventListener('mousemove', move);
    document.removeEventListener('mouseup', end);
    document.removeEventListener('touchmove', move);
    document.removeEventListener('touchend', end);
    localStorage.setItem(key + ':pos', JSON.stringify({ left: box.style.left, top: box.style.top }));
  }

  handle.addEventListener('mousedown', start);
  handle.addEventListener('touchstart', start, { passive:false });
})();
</script>



<!-- app wiring -->
<script type="module" src="../js/main.js"></script>

<!-- draggable dock logic -->
<script type="module">
(() => {
  const dock  = document.querySelector('.control-dock');
  const panel = dock?.querySelector('.panel');
  if (!dock || !panel) return;

  const handle = panel.querySelector('.dock-handle');

  // restore saved position (if any)
  const saved = localStorage.getItem('mf:dock-pos');
  if (saved) {
    const pos = JSON.parse(saved);
    dock.style.left   = pos.left;
    dock.style.top    = pos.top;
    dock.style.right  = 'auto';
    dock.style.bottom = 'auto';
    dock.style.transform = 'none';
  }

  let dragging = false, grabDX = 0, grabDY = 0, dockW = 0, dockH = 0;

  const pt = (e) => (e.touches?.[0]) ? { x:e.touches[0].clientX, y:e.touches[0].clientY }
                                     : { x:e.clientX,             y:e.clientY };

  function start(e){
    const p = pt(e);
    const r = dock.getBoundingClientRect();
    dragging = true;
    grabDX = p.x - r.left; grabDY = p.y - r.top; dockW = r.width; dockH = r.height;

    // switch to left/top anchoring
    dock.style.left = `${r.left}px`; dock.style.top = `${r.top}px`;
    dock.style.right = 'auto'; dock.style.bottom = 'auto'; dock.style.transform = 'none';

    dock.classList.add('dragging'); panel.classList.add('dragging');
    e.preventDefault?.();
  }
  function move(e){
    if (!dragging) return;
    const p = pt(e); const vw = innerWidth; const vh = innerHeight;
    let x = p.x - grabDX, y = p.y - grabDY;
    x = Math.max(8, Math.min(vw - dockW - 8, x));
    y = Math.max(8, Math.min(vh - dockH - 8, y));
    dock.style.left = `${x}px`; dock.style.top = `${y}px`;
    if (e.cancelable) e.preventDefault();
  }
  function end(){
    if (!dragging) return;
    dragging = false;
    dock.classList.remove('dragging'); panel.classList.remove('dragging');
    localStorage.setItem('mf:dock-pos', JSON.stringify({ left:dock.style.left, top:dock.style.top }));
  }

  handle.addEventListener('mousedown', start);
  addEventListener('mousemove', move);
  addEventListener('mouseup', end);

  handle.addEventListener('touchstart', start, { passive:false });
  addEventListener('touchmove', move, { passive:false });
  addEventListener('touchend', end);
})();
</script>

<!-- optional: post-measure redirect hook you already had -->
<script type="module">
  window.finishMeasurement = (length_mm, width_mm) => {
    sessionStorage.setItem("mf:length_mm", String(length_mm));
    sessionStorage.setItem("mf:width_mm",  String(width_mm));
    sessionStorage.removeItem("mf:grip");
    location.href = "/htmls/report.html";
  };
</script>
</body>
</html>
