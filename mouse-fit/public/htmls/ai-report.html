<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mouse-Fit — AI Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/neon.css" />
  <style>
    :root {
      --chipBg: rgba(255,255,255,.06);
      --chipBd: rgba(255,255,255,.12);
      --grad-palm-a: 82, 0, 163;   /* purple */
      --grad-palm-b: 167, 94, 246;
      --grad-claw-a: 14, 98, 255;  /* blue */
      --grad-claw-b: 104, 169, 255;
      --grad-tip-a: 214, 31, 105;  /* pink */
      --grad-tip-b: 255, 139, 197;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: clamp(20px,4vw,40px); }
    .title { font-family: Sora, system-ui, sans-serif; font-weight: 800; letter-spacing:-.02em;
             font-size: clamp(26px,4vw,40px); line-height:1.1; }
    .subtitle { color: var(--muted); margin: 6px 0 14px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0 6px; }
    .btn { background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
           border:1px solid var(--border); padding:10px 14px; border-radius:12px; color:var(--fg);
           font-weight:600; cursor:pointer; transition: transform .15s ease, box-shadow .2s ease; }
    .btn:active { transform: translateY(1px) scale(.99); }

    .report-card {
      margin-top: 18px; border: 1px solid var(--border); border-radius: 18px;
      padding: 16px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .report-card h2 { font-size: clamp(18px,2.6vw,22px); margin: 0 0 6px; }
    .para { white-space: pre-wrap; line-height: 1.5; }
    .hr { height:1px; background: var(--border); margin: 12px 0; opacity:.7; }

    .chips { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
             gap:12px; margin-top:12px; }
    .chip {
      border: 1px solid var(--chipBd);
      background: var(--chipBg);
      border-radius: 16px; padding: 12px 14px;
      font-weight: 700; position: relative; overflow: hidden;
    }
    .chip small { display:block; font-weight:600; color: var(--muted); margin-top:6px; }
    .chip .pct {
      position: absolute; right: 10px; top: 10px; font-weight: 800; opacity: .9;
    }
    .chip.best { box-shadow: 0 0 0 1px rgba(255,255,255,.2), 0 8px 28px rgba(0,0,0,.35); }

    /* grip overlays @ 50% opacity */
    .bg-palm::before,
    .bg-claw::before,
    .bg-tip::before {
      content: ""; position: absolute; inset: 0; z-index: 0; pointer-events: none;
      opacity: .5;  /* 50% */
    }
    .bg-palm::before {
      background: linear-gradient(135deg,
        rgba(var(--grad-palm-a),1) 0%,
        rgba(var(--grad-palm-b),1) 100%);
    }
    .bg-claw::before {
      background: linear-gradient(135deg,
        rgba(var(--grad-claw-a),1) 0%,
        rgba(var(--grad-claw-b),1) 100%);
    }
    .bg-tip::before {
      background: linear-gradient(135deg,
        rgba(var(--grad-tip-a),1) 0%,
        rgba(var(--grad-tip-b),1) 100%);
    }
    .chip > * { position: relative; z-index: 1; } /* keep text above overlay */

    .status { font-size:12px; color:var(--muted); min-height:18px; margin-top:8px; white-space:pre-wrap; }
    .link { color: var(--fg); opacity:.9; text-decoration: underline; }
  </style>
</head>
<body>
  <main class="wrap">
    <a href="/htmls/report.html" class="link">← Back to Results</a>
    <h1 class="title">AI-Generated Mouse Report</h1>
    <p class="subtitle">A clean, two-paragraph summary based on the mice in your code list.</p>

    <div class="controls">
      <button class="btn" id="btn-generate">Generate AI Report</button>
      <button class="btn" id="btn-refine-then-generate">Refine Order → Generate</button>
      <button class="btn" id="btn-copy">Copy Text</button>
    </div>
    <div class="status" id="status"></div>

    <section class="report-card" id="card" aria-live="polite">
      <h2>Personalized Mouse Report</h2>
      <div id="p1" class="para"></div>
      <div class="hr"></div>
      <div id="p2" class="para"></div>
    </section>

    <section style="margin-top:20px">
      <h3 style="margin:0 0 8px">Matching Models</h3>
      <div id="chips" class="chips"></div>
    </section>
  </main>

  <script type="module">
    const MICE_JS_PATH = "/js/mice.js"; // ← change if your file lives elsewhere

    // Load profile (optional; used by reranker/report)
    function getSeedProfile() {
      try { return (JSON.parse(localStorage.getItem("mousefit.reportSeed")) || {}).profile || {}; }
      catch { return {}; }
    }
    const state = { profile: getSeedProfile(), candidates: [], ranked: [] };

    const $status = document.getElementById("status");
    const $p1 = document.getElementById("p1");
    const $p2 = document.getElementById("p2");
    const $chips = document.getElementById("chips");
    const setStatus = (m) => ($status.textContent = m || "");

    // ----- load mice.js (supports ES export or window globals) -----
    async function loadMiceFromCode() {
      if (Array.isArray(window.MICE)) return window.MICE;
      if (Array.isArray(window.mice)) return window.mice;
      if (Array.isArray(window.MOUSE_DB)) return window.MOUSE_DB;
      try {
        const mod = await import(MICE_JS_PATH);
        return (mod.default && Array.isArray(mod.default)) ? mod.default
          : (Array.isArray(mod.MICE) ? mod.MICE
          : (Array.isArray(mod.mice) ? mod.mice : []));
      } catch { return []; }
    }

    // ----- normalizers -----
    const toSlug = (s) => String(s).trim().toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
    const grams = (s) => {
      const m = String(s||"").match(/(\d+(?:\.\d+)?)\s*g\b/i);
      return m ? +m[1] : undefined;
    };
    const dimTriplet = (s) => {
      const m = String(s||"").match(/(\d+(?:\.\d+)?)\s*[×x]\s*(\d+(?:\.\d+)?)\s*[×x]\s*(\d+(?:\.\d+)?)/);
      return m ? { length_mm:+m[1], width_mm:+m[2], height_mm:+m[3] } : {};
    };
    const shapeFrom = (s) => /ergo/i.test(s) ? "ergo" : (/sym|ambidex/i.test(s) ? "sym" : undefined);

    function normalizeMouse(item) {
      if (typeof item === "string") {
        const head = item.split("—")[0]?.trim() || "";
        const [brand, ...rest] = head.split(/\s+/);
        const model = rest.join(" ").trim();
        if (!brand || !model) return null;
        const dims = dimTriplet(item);
        const weight_g = grams(item);
        const shape = shapeFrom(item);
        return { id: toSlug(`${brand} ${model}`), brand, model, ...dims, weight_g, shape };
      }
      if (item && typeof item === "object") {
        const brand = item.brand || item.make || "";
        const model = item.model || item.name || "";
        if (!brand || !model) return null;
        const id = item.id || toSlug(`${brand} ${model}`);
        const weight_g = item.weight_g ?? item.weight ?? grams(item.spec || "");
        const dims = ("length_mm" in item || "width_mm" in item || "height_mm" in item)
          ? { length_mm: item.length_mm, width_mm: item.width_mm, height_mm: item.height_mm }
          : dimTriplet(item.spec || "");
        const shape = item.shape || shapeFrom(item.spec || "");
        return { id, brand, model, ...dims, weight_g, shape };
      }
      return null;
    }
    function dedupeById(arr) { const m = new Map(); for (const c of arr) if (c && c.id && !m.has(c.id)) m.set(c.id,c); return [...m.values()]; }

    // ----- API helpers -----
    async function postJSON(url, body) {
      const r = await fetch(url, { method: "POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body||{}) });
      const text = await r.text(); let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }
      if (!r.ok) throw (data.error || data.raw || r.statusText);
      return data;
    }

    // ----- grip gradient class from flags -----
    function gripClassFor(flags, fallbackGrip) {
      const arr = (flags || []).map(x => String(x).toLowerCase());
      if (arr.includes("palm")) return "bg-palm";
      if (arr.includes("claw")) return "bg-claw";
      if (arr.includes("fingertip") || arr.includes("tip") || arr.includes("finger")) return "bg-tip";
      const g = (fallbackGrip || "").toLowerCase();
      if (g === "palm") return "bg-palm";
      if (g === "claw") return "bg-claw";
      if (g.startsWith("finger")) return "bg-tip";
      return ""; // no overlay
    }

    // ----- render ranked chips -----
    function renderChipsRanked(ranked, gripGlobal) {
      $chips.innerHTML = "";
      if (!ranked.length) {
        $chips.innerHTML = `<div class="chip">No models available.</div>`;
        return;
      }
      const max = Math.max(...ranked.map(r => +r.score || 0), 1);
      const min = Math.min(...ranked.map(r => +r.score || 0), 0);
      for (let i=0; i<ranked.length; i++) {
        const r = ranked[i];
        const c = r._base; // normalized mouse object we attached
        const spec = [
          (c.weight_g || c.weight) ? `${c.weight_g || c.weight} g` : "",
          c.shape || ""
        ].filter(Boolean).join(", ");
        const pct = Math.round(100 * ((+r.score || 0) - min) / (max - min || 1));
        const node = document.createElement("div");
        const gclass = gripClassFor(r.flags, gripGlobal);
        node.className = `chip ${gclass} ${i===0 ? "best":""}`;
        node.innerHTML = `
          <div class="pct">${pct}%</div>
          <div>${c.brand} ${c.model}</div>
          ${spec ? `<small>${spec}</small>` : ""}
        `;
        $chips.appendChild(node);
      }
    }

    // ----- sanitize paragraphs (no measurements/colorways) -----
    function sanitizeReport(text) {
      const [a0 = "", b0 = ""] = (text || "").trim().split(/\n\s*\n/);
      const strip = s => s.split(/\n+/).filter(line =>
        !/\b(hand|palm)\s*(length|width|size)\b/i.test(line) &&
        !/\bgrip style\b/i.test(line) &&
        !/\b(colorway|colorways|color|edition)\b/i.test(line)
      ).join("\n");
      return [strip(a0).trim(), strip(b0).trim()];
    }
    function renderTwoParagraphs(text) {
      const [a, b] = sanitizeReport(text);
      $p1.textContent = a;
      $p2.textContent = b;
    }

    // ----- main flow -----
    async function boot() {
      try {
        setStatus("Loading mice from code…");
        const raw = await loadMiceFromCode();
        const normalized = dedupeById(raw.map(normalizeMouse).filter(Boolean));
        state.candidates = normalized;
        setStatus("");

        // 1) RERANK with RAG → get scores & flags per id
        setStatus("Scoring fit…");
        const rer = await postJSON("/api/rerank", { profile: state.profile || {}, candidates: state.candidates });
        const map = new Map(state.candidates.map(c => [c.id, c]));
        const ranked = (rer.ranked || []).map(r => ({ ...r, _base: map.get(r.id) || { brand:"", model:"" }}))
                          .filter(x => x._base.brand && x._base.model);
        // If reranker returned fewer than we sent, append the rest with low score to keep UI full
        const used = new Set(ranked.map(r => r.id));
        for (const c of state.candidates) {
          if (!used.has(c.id)) ranked.push({ id:c.id, score: 0, flags: [], _base:c });
        }
        // Sort by score desc
        ranked.sort((a,b) => (b.score||0) - (a.score||0));
        state.ranked = ranked;

        // 2) Render chips ordered by best fit
        renderChipsRanked(state.ranked, rer.grip || state.profile?.grip || "");

        // 3) Generate two-paragraph summary
        setStatus("Generating summary…");
        const rep = await postJSON("/api/report", { profile: state.profile || {}, candidates: state.candidates });
        renderTwoParagraphs(rep.report || "");
        setStatus("");
      } catch (e) {
        setStatus(String(e || "Error"));
      }
    }

    // Buttons
    document.getElementById("btn-generate").addEventListener("click", boot);
    document.getElementById("btn-refine-then-generate").addEventListener("click", boot);
    document.getElementById("btn-copy").addEventListener("click", async () => {
      try {
        const text = [$p1.textContent.trim(), $p2.textContent.trim()].filter(Boolean).join("\n\n");
        await navigator.clipboard.writeText(text);
        setStatus("Copied."); setTimeout(()=>setStatus(""), 1200);
      } catch { setStatus("Copy failed."); }
    });

    // Auto-run on load
    boot();
  </script>
</body>
</html>
