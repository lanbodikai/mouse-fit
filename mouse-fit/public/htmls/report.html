<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mouse-Fit — Measurement Report</title>
    <link rel="stylesheet" href="/neon.css" />
  </head>
  <body>
    <nav class="mf-nav">
      <a class="brand" href="/">MF</a>
      <div class="nav-links">
        <a href="/">Home</a>
        <a href="/#projects">Projects</a>
        <a href="/htmls/about.html">About the author</a>
        <a href="/htmls/mouse-db.html">Mouse-Database <span class="soon">soon</span></a>
      </div>
      <div class="nav-cta">
        <a class="pill" href="/htmls/ai.html">Mouse-Finder AI</a>
      </div>
    </nav>

    <main class="mf-report">
      <h1>Your Hand Measurement Report</h1>

      <div class="result-container">
        <img id="snapshot" alt="Hand snapshot" />
        <div id="measurements">
          <p><strong>Hand length:</strong> <span id="handLength"></span> cm</p>
          <p><strong>Palm width:</strong> <span id="handWidth"></span> cm</p>
          <p><strong>Hand size category:</strong> <span id="handSize"></span></p>
          <p><strong>Suggested grip style(s):</strong> <span id="suggestedGrip"></span></p>
        </div>
      </div>

      <div id="gripBox" class="mf-report-actions">
        <a href="/htmls/grip.html" class="pill">Open Grip Checker</a>
        <button id="redoBtn">Redo test</button>
        <button id="askAI" class="pill">Ask MouseFit AI</button>
        <span id="gripPill" class="pill">Grip: not checked</span>
      </div>

      <div id="gripThumbs" class="grip-thumbs" style="display:none;">
        <img id="gripTop"   alt="Top view">
        <img id="gripRight" alt="Right view">
        <img id="gripLeft"  alt="Left view">
      </div>

      <h2>Recommended Mice</h2>
      <p class="note">Top picks for each grip style, sorted by compatibility:</p>
      <h3>Palm Grip Recommendations</h3>
      <ul id="listPalm"></ul>
      <h3>Claw Grip Recommendations</h3>
      <ul id="listClaw"></ul>
      <h3>Fingertip Grip Recommendations</h3>
      <ul id="listFingertip"></ul>
    </main>

    <!-- your original report scripts (unchanged, just works) -->
    <script>
      const measure = JSON.parse(localStorage.getItem("mousefit:measure") || "{}");
      const rec = JSON.parse(localStorage.getItem("mousefit:recs") || "{}");
      if (!measure.len_cm) {
        document.body.innerHTML = "<p class='mf-empty'>No measurement data found. Please return to the main page to measure your hand.</p>";
      } else {
        const snapshotData = localStorage.getItem("mousefit:snapshot");
        if (snapshotData) document.getElementById("snapshot").src = snapshotData;
        else document.getElementById("snapshot").style.display = "none";

        document.getElementById("handLength").textContent = measure.len_cm;
        document.getElementById("handWidth").textContent = measure.wid_cm;
        document.getElementById("handSize").textContent = rec.size;

        const size = rec.size;
        let gripSuggestion = "";
        if (size === "small") {
          gripSuggestion = "You might find a claw grip comfortable, though palm is also a versatile choice.";
        } else if (size === "medium") {
          gripSuggestion = "Palm grip is a versatile choice; experiment with claw or fingertip based on preference.";
        } else if (size === "large" || size === "xlarge") {
          gripSuggestion = "Fingertip can feel natural; palm grip may also be comfortable.";
        } else gripSuggestion = "Any grip style can work — choose what feels most natural.";
        document.getElementById("suggestedGrip").textContent = gripSuggestion;

        const ulPalm = document.getElementById("listPalm");
        const ulClaw = document.getElementById("listClaw");
        const ulTip  = document.getElementById("listFingertip");

        function hideHeading(ul) {
          const h = ul && ul.previousElementSibling;
          if (h && /^H\d$/.test(h.tagName)) h.style.display = "none";
        }
        function addItems(ul, arr, label) {
          ul.innerHTML = "";
          if (!arr || !arr.length) {
            const li = document.createElement("li");
            li.textContent = "No data available";
            ul.appendChild(li);
            return;
          }
          arr.forEach(mouse => {
            const li = document.createElement("li");
            li.textContent =
              `${mouse.brand} ${mouse.model} — ${mouse.weight_g} g — ` +
              `${mouse.length_mm}×${mouse.width_mm}×${mouse.height_mm} mm — ` +
              `${mouse.shape} (${label} grip)`;
            ul.appendChild(li);
          });
        }

        let palmList = (rec.top && rec.top.palm) || [];
        let clawList = (rec.top && rec.top.claw) || [];
        let tipList  = (rec.top && rec.top.fingertip) || [];

        const pref = JSON.parse(localStorage.getItem("mousefit:grip_pref") || "{}");
        const handLenMm = Number(measure.len_mm || 0);

        if (pref.grip === "claw" && pref.relaxed && handLenMm) {
          const minLen = 0.64 * handLenMm;
          const getLen = m => Number(m.length_mm ?? m.length ?? 0);
          const larger = clawList.filter(m => getLen(m) >= minLen);
          if (larger.length) clawList = larger;
        }

        if (pref.grip === "palm") {
          addItems(ulPalm, palmList, "Palm");
          ulClaw.innerHTML = ""; ulTip.innerHTML = "";
          hideHeading(ulClaw); hideHeading(ulTip);
        } else if (pref.grip === "claw") {
          addItems(ulClaw, clawList, pref.relaxed ? "Claw (relaxed bias)" : "Claw");
          ulPalm.innerHTML = ""; ulTip.innerHTML = "";
          hideHeading(ulPalm); hideHeading(ulTip);
        } else if (pref.grip === "fingertip") {
          addItems(ulTip, tipList, "Fingertip");
          ulPalm.innerHTML = ""; ulClaw.innerHTML = "";
          hideHeading(ulPalm); hideHeading(ulClaw);
        } else {
          addItems(ulPalm, palmList, "Palm");
          addItems(ulClaw, clawList, "Claw");
          addItems(ulTip,  tipList,  "Fingertip");
        }
      }

      (function showGrip() {
        const pill = document.getElementById("gripPill");
        if (!pill) return;

        const topB64   = localStorage.getItem("mousefit:grip_view_top");
        const rightB64 = localStorage.getItem("mousefit:grip_view_right");
        const leftB64  = localStorage.getItem("mousefit:grip_view_left");
        if (topB64 || rightB64 || leftB64) {
          const box = document.getElementById("gripThumbs");
          if (box) box.style.display = "flex";
          if (topB64)   document.getElementById("gripTop").src   = topB64;
          if (rightB64) document.getElementById("gripRight").src = rightB64;
          if (leftB64)  document.getElementById("gripLeft").src  = leftB64;
        }

        try {
          const r = JSON.parse(localStorage.getItem("mousefit:grip_result") || "{}");
          const grip = (r.grip || r.local_guess?.grip || "").toLowerCase();
          const conf = Math.round(100 * (r.confidence ?? r.local_guess?.confidence ?? 0));
          if (grip) pill.textContent = conf ? `Grip: ${grip} (${conf}%)` : `Grip: ${grip}`;
        } catch {}
      })();

      (function wireAskAI(){
        const btn = document.getElementById('askAI');
        if (!btn) return;
        btn.onclick = () => {
          let lenCm = "", widCm = "", grip = "";
          try {
            const m = JSON.parse(localStorage.getItem("mousefit:measure") || "{}");
            if (m.len_mm) lenCm = (m.len_mm / 10).toFixed(1);
            if (m.wid_mm) widCm = (m.wid_mm / 10).toFixed(1);
          } catch {}
          grip = localStorage.getItem("gripGuess")
              || localStorage.getItem("mousefit:grip")
              || "";
          const params = new URLSearchParams();
          if (lenCm) params.set("len", lenCm);
          if (widCm) params.set("wid", widCm);
          if (grip)  params.set("grip", grip.toLowerCase());
          window.location.href = "/htmls/ai.html?" + params.toString();
        };
      })();
    </script>
  </body>
</html>
