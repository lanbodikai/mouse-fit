<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MouseFit AI</title>
  <link rel="stylesheet" href="src/neon.css">
</head>
<body>
  <div class="nav">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
      <div class="brand h2"><span class="grad">MouseFit AI</span></div>
      <div style="display:flex;gap:10px;align-items:center;">
        <a class="pill" href="home.html">Home</a>
        <a class="pill" href="measure.html">Mouse Checker</a>
        <a class="pill" href="report.html">Report</a>
        <span id="ollamaStatus" class="pill">Local AI: checking…</span>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="stack">
      <!-- Left: inputs -->
      <div class="card glow" style="flex:0.9">
        <div class="h2">Tell me about your hand & preferences</div>

        <div class="stack">
          <div style="flex:1">
            <label>Hand length (cm)</label>
            <input id="len" inputmode="decimal" placeholder="e.g., 18.0">
          </div>
          <div style="flex:1">
            <label>Palm width (cm)</label>
            <input id="wid" inputmode="decimal" placeholder="e.g., 8.0">
          </div>
        </div>

        <div class="stack">
          <div style="flex:1">
            <label>Grip style</label>
            <select id="grip">
              <option value="">(choose)</option>
              <option>palm</option>
              <option>claw</option>
              <option>fingertip</option>
              <option>relaxed claw</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Current mouse</label>
            <input id="current" placeholder="e.g., Logitech G Pro X Superlight 2">
          </div>
        </div>

        <label>What do you like / dislike? (hump, size, weight, shape, budget…)</label>
        <textarea id="prefs" placeholder="Example: hump too high; want slightly smaller and lighter; prefer symmetrical shells."></textarea>

        <div class="stack" style="margin-top:10px">
          <button class="btn" id="run">Get suggestions</button>
          <button class="btn ghost" id="prefill">Use last measurement</button>
          <button class="btn ghost" id="clear">Clear</button>
        </div>
        <div class="small" style="margin-top:8px">
          Tip: keep Ollama running locally with <code>ollama run llama3.2</code>.
        </div>
      </div>

      <!-- Right: chat -->
      <div class="card glow" style="flex:1.1; display:flex; flex-direction:column; gap:14px;">
        <div class="h2" style="margin-bottom:0">AI conversation</div>
        <div id="chat" class="chat card" style="padding:12px"></div>
        <div class="small">Model: <code>llama3.2</code> via Ollama (local). If blocked over HTTPS, run from <code>http://localhost</code>.</div>
      </div>
    </div>
  </main>

  <!-- Optional: your existing local runner (keep if you have it) -->
  <script src="ai_local.js" defer></script>

  <script>
    /* =================== helpers =================== */
    const $ = sel => document.querySelector(sel);
    const chat = $('#chat');

    function pushMsg(text, who='ai'){
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user':'ai');
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function setStatus(text){ $('#ollamaStatus').textContent = text; }

    // Detect Ollama
    const OLLAMA_URL = 'http://127.0.0.1:11434';
    async function detectOllama(){
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), 1800);
        const r = await fetch(OLLAMA_URL + '/api/tags', {signal:ctrl.signal});
        clearTimeout(t);
        if (r.ok) { setStatus('Local AI: ready'); return true; }
      }catch(e){}
      setStatus('Local AI: not reachable');
      return false;
    }
    detectOllama();

    // Prefill from query (?len=&wid=&grip=) or localStorage
    (function prefill(){
      const q = new URLSearchParams(location.search);
      if (q.get('len')) $('#len').value = q.get('len');
      if (q.get('wid')) $('#wid').value = q.get('wid');
      if (q.get('grip')) $('#grip').value = q.get('grip');

      // If empty, try last measured numbers
      if (!$('#len').value || !$('#wid').value){
        try{
          const m = JSON.parse(localStorage.getItem('mousefit:measure')||'{}');
          if (m.len_mm) $('#len').value = (m.len_mm/10).toFixed(1);
          if (m.wid_mm) $('#wid').value = (m.wid_mm/10).toFixed(1);
        }catch{}
      }
    })();

    // Prefill button
    $('#prefill').onclick = () => {
      try{
        const m = JSON.parse(localStorage.getItem('mousefit:measure')||'{}');
        if (m.len_mm) $('#len').value = (m.len_mm/10).toFixed(1);
        if (m.wid_mm) $('#wid').value = (m.wid_mm/10).toFixed(1);
      }catch{}
      const r = JSON.parse(localStorage.getItem('mousefit:grip_result')||'{}');
      const g = (r.grip || r.local_guess?.grip || '').toLowerCase();
      if (g) $('#grip').value = g;
    };

    $('#clear').onclick = () => {
      ['len','wid','grip','current','prefs'].forEach(id => $('#'+id).value='');
      chat.innerHTML = '';
    };

    function buildPrompt(){
      const len = $('#len').value.trim();
      const wid = $('#wid').value.trim();
      const grip = $('#grip').value.trim();
      const cur = $('#current').value.trim();
      const prefs = $('#prefs').value.trim();

      let p = `You are MouseFit AI, a mouse fit expert.\n` +
              `User hand length: ${len ? len+' cm' : 'unknown'}; palm width: ${wid ? wid+' cm' : 'unknown'}.\n` +
              `Grip style: ${grip || 'unspecified'}.\n` +
              (cur ? `Current mouse: ${cur}.\n` : '') +
              (prefs ? `User notes: ${prefs}.\n` : '') +
              `Return 6–10 recommendations ranked with brief reasons. Prefer mainstream (Razer/Logitech), then mid (Vaxee/Lamzu/Pulsar/Zowie/G-Wolves), then niche (WLmouse/Endgame/etc). ` +
              `Bias lighter mice for fingertip; allow slightly larger for relaxed claw; suggest longer ~120mm ergos for palm if hand is large. ` +
              `Format as a simple bulleted list: Brand Model — one short reason.`;
      return p;
    }

    async function runWithOllama(prompt){
      // If you already have window.runLocalAI from ai_local.js, use it.
      if (typeof window.runLocalAI === 'function'){
        return await window.runLocalAI(prompt);
      }
      // Raw Ollama fallback
      const body = { model: 'llama3.2', prompt, stream:false };
      const r = await fetch(OLLAMA_URL + '/api/generate',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      const j = await r.json();
      return j.response || '';
    }

    async function run(){
      const prompt = buildPrompt();
      pushMsg(prompt, 'user');
      try{
        const ok = await detectOllama();
        if (!ok) pushMsg('Heads up: Local Ollama not reachable. If this page is on GitHub Pages (HTTPS), the browser may block http://127.0.0.1. Run this from http://localhost or use your FastAPI proxy.', 'ai');
        const out = await runWithOllama(prompt);
        pushMsg(out || 'No response', 'ai');
      }catch(err){
        pushMsg('Error contacting local model. ' + err, 'ai');
      }
    }

    $('#run').onclick = run;
  </script>
</body>
</html>
